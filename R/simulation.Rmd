---
title: "Simulation"
author: "Kari Norman"
date: "7/24/2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(tidyverse)
library(gstat)
library(sp)
```

Set simulation parameters
```{r}
#n for the n x n landscape grid
grid_size <- 100

#number of species
n_sp <- 5

#number of environmental variables
n_env <- 3
```

Create gridded environmental variables 
```{r}
# unconditional gaussian simulation of environmental variables using gstat
grid <- expand.grid(1:grid_size, 1:grid_size)
colnames(grid) <- c("x", "y")
 
# define the gstat object (spatial model)
spat_mod <- gstat(formula=z~1, locations=~x+y, dummy=T, beta=1, model=vgm(psill=0.025,model="Exp",range=5), nmax=20, data = grid)
 
# simulate specified number of environmental variables
sims <- predict(spat_mod, newdata=grid, nsim=n_env)
 
# visualize
gridded(sims) = ~x+y
spplot(sims)

#convert to data frame of cells and simulated variables
env_data <- as.data.frame(sims)
```

Create dataframe of environmental suitability for each species 
```{r}
#function for getting a random range within an existing range
ran_range <- function(range){
  lower <- runif(1, range[1], range[2])
  upper <- runif(1, lower, range[2])
  
  return(data.frame(type = c("min", "max"), range = c(lower, upper)))
}

### get ranges for each species as two min and max columns ###
#get ranges for environmental variables 
env_ranges <- map(env_data %>% select(-x, -y), ~range(.x))

#dataframe of environmental decision rules
species_env <- map_dfr(1:n_sp, 
                       ~map_dfr(env_ranges, ~ran_range(.x), .id = "env_var") %>% 
                         mutate(species = paste0("spec", .x, "_env"))
                       )

```

Create matrix species exclusion rules
```{r}
#random assignment of cooccurrence, 0 = can occur, 1 = excludes
co <- sample.int(2, n_sp^2, TRUE) - 1
dim(co) <- c(n_sp, n_sp)

species_names <- paste0("spec", 1:n_sp)
co <- as.data.frame(co)
colnames(co) <- species_names
co <- cbind(co, species = species_names)
```

Identify potential species occupancy based on environmental requirements 
```{r}
#cases <- map(unique(species_env$env_var), ~substitute())
  
get_spec_occ <- function(species_name, data = env_data, ranges = species_env){
  data %>% mutate(!!species_name := case_when(sim1 > filter(ranges, species == species_name, env_var == "sim1", type == "min")$range &
                                        sim1 < filter(ranges, species == species_name, env_var == "sim1", type == "max")$range &
                                        sim2 > filter(ranges, species == species_name, env_var == "sim2", type == "min")$range &
                                        sim2 < filter(ranges, species == species_name, env_var == "sim2", type == "max")$range &
                                        sim3 > filter(ranges, species == species_name, env_var == "sim3", type == "min")$range &
                                        sim3 < filter(ranges, species == species_name, env_var == "sim3", type == "max")$range ~ 1,
                                      TRUE ~ 0)) %>%
    select(species_name)
}

occ <- map_dfc(paste0("spec", 1:n_sp, "_env"), get_spec_occ)


```

Exclude species based on other species present
```{r}

exclude_species <-
  function(species_name,
           exclusion_mat = co,
           occ_mat = occ) {
    ex_species <- exclusion_mat %>%
      select(species, species_name) %>%
      filter(!!sym(species_name) == 1) %>%
      pull(species)
      
      
      if (length(ex_species) > 0) {
        ex_species <- paste0(ex_species, "_env")
        
        occ %>% mutate(!!species_name := case_when(sum(!!!syms(ex_species)) >= 1 ~ 0, #if at least one species that can exclude occurs assign as not present
                                                   TRUE ~ !!sym(paste0(
                                                     species_name, "_env"
                                                   )))) %>% #otherwise accept existing value
          select(species_name)
      } else{
        return(select(occ, !!sym(species_name)))
      }
    
  }

data <- map_dfc(paste0("spec", 1:n_sp), exclude_species) %>% 
  bind_cols(env_data, .)
```

Programatically generate case example
```{r}
labels <- c("low", "mid", "high")
breaks <- c(2, 4)

cases <- lapply(seq_along(breaks), function(i) {
  substitute(carb <= breaks[i] ~ labels[i], list(i = i))
})
cases <- append(cases, substitute(TRUE ~ labels[length(labels)]))
```

Features to add
* realistic environmental variable ranges
* programmatically generate environmental filtering `case_when`
* species co-occurence filter 













